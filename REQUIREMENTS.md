# MySQL 用户迁移工具需求说明

## 背景
在异构或分环境演进中，需要将指定 MySQL 实例的用户（用户名、密码、Host、权限）迁移到目标实例，同时避免手工执行带来的风险与遗漏。本工具聚焦用户与权限搬迁，不涉及业务数据迁移。

## 范围
- 源、目标均为 MySQL 5.7+ 或兼容发行版。
- 迁移对象：用户账号、认证信息（含密码 hash/认证插件）、Host 绑定、权限（全局与库/表级）。
- 可选范围控制：显式包含名单、显式排除名单。

## 功能需求
1. 连接管理：支持通过命令行参数或环境变量指定源/目标连接（含 `host`、`port`、`user`、`password`、`tls` 选项）。
2. 用户筛选：
   - `--include user1,user2` 仅迁移指定用户。
   - `--exclude user3,user4` 排除指定用户。
   - 支持 host 维度过滤（如 `user@'10.%'`）。
3. 权限同步：抓取源端 `GRANT` 信息，映射到目标端，确保与源端一致；可选 `--drop-missing` 清理目标端额外权限。
4. 密码与认证：保持密码 hash 和认证插件一致；若目标版本不兼容，需要报告并提供跳过/失败策略。
5. 幂等与校验：重复运行应无副作用；迁移后校验用户、host、权限一致性。
6. 干跑与执行模式：
   - `--dry-run`：只生成计划与报告，不对目标执行。
   - 默认执行模式；遇到冲突可选择 `--force-overwrite` 或跳过。
7. 报告输出：迁移完成生成报告（stdout 及文件），包含成功/失败用户列表、变更摘要、校验结果、耗时。
8. 日志：提供可读日志，支持 `--verbose`。
9. 配置文件：支持 `--config path` 读取 YAML/JSON，包含源/目标列表、包含/排除规则、干跑/执行模式等。
10. 多目标迁移：支持一对多（单源多目标）批量迁移；应串行或可配置并发执行，每个目标独立报告并汇总总览。

## 非功能需求
- 安全：不记录明文密码；日志和报告中掩码敏感信息。
- 鲁棒性：网络或权限错误应给出可诊断的错误信息，不应造成目标脏状态。
- 可移植性：单一可执行文件（Go 编译），无外部依赖；可在 Linux/macOS 运行。
- 性能：支持至少几百个用户的迁移，单次运行完成在可接受时间内（< 数分钟，视网络与目标负载而定）。

## 配置与接口
- 命令行示例：
  - `mysql-user-migrate --source dsn --target dsn --include user1,user2 --dry-run`
  - `mysql-user-migrate --source dsn --target dsn --exclude root,test --report report.json`
- 环境变量：支持 `SOURCE_DSN`、`TARGET_DSN` 或分散的 `DB_HOST/PORT/USER/PASS`.
- 配置文件（可选）：支持 YAML/JSON 读取批量参数（源/目标列表、包含/排除、模式、并发度、报告路径）。

## 报告要求
- 必含：时间戳、源/目标标识、模式（dry-run/执行）、成功用户、失败用户及原因、权限对比摘要、校验结论。
- 输出格式：默认 stdout 友好表格，`--report path` 可写 JSON/Markdown。

## 安全与合规
- 禁止在报告中输出真实密码或完整连接串。
- 默认不迁移 `root`/系统账号，需显式 `--include root` 才可。
- 支持最少权限连接；目标端执行前可选 `--precheck` 验证所需权限。
